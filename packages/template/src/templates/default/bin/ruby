#!/usr/bin/env -S node --disable-warning=ExperimentalWarning

import { initVM, ExternalCommands, runRubyScript, isRubyShebangScript } from "@tutorialkit-rb/rails-wasm";
import path from "node:path";

const __dirname = path.dirname(new URL(import.meta.url).pathname);
const commands = new ExternalCommands();
global.externalCommands = commands;

const args = process.argv.slice(2);

if (args[0] && isRubyShebangScript(path.join(process.cwd(), args[0]))) {
  // Handle shebang script execution
  const scriptPath = args.shift()!;
  const vm = await initVM({
    env: { "HOME": "/rails-vm" },
    workspaceDir: path.join(__dirname, "../workspace"),
    pgDataDir: path.join(__dirname, "../pgdata")
  });

  await runRubyScript(scriptPath, args, vm);
  commands.invoke(vm);
} else {
  // Handle interactive Ruby or direct Ruby execution
  const vm = await initVM({
    env: { "HOME": "/rails-vm" },
    args,
    skipRails: true,
    workspaceDir: path.join(__dirname, "../workspace"),
    pgDataDir: path.join(__dirname, "../pgdata")
  });
  commands.invoke(vm);
}